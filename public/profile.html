<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<a href="./index">Strona Główna</a>
<a href="./profileEditor">Edytuj</a>
<div id="profile"></div>
<button id="deleteUser">Usuń konto</button>
<h3>Twoje ogłoszenia</h3>
<div id="notices"></div>

<body>
    <script>
        const profile = document.getElementById('profile');
        const noticesDiv = document.getElementById('notices');
        const delUserBtn = document.getElementById('deleteUser');

        delUserBtn.addEventListener("click", ()=>{
            fetch('/deleteUser', { method: 'DELETE', redirect: 'follow', }) 
                .then(res => {
                    if (res.redirected) return window.location.href = res.url; 
                    else res.json().then(data => console.log(data)); 
                })
        });


        window.addEventListener("pageshow", () => {
            fetch('/getUser').then(res => res.json()).then(data => {
                let noticesIds = [];
                if (data) {
                    for (key in data) {
                        if(key === "notices"){ 
                            noticesIds = (data[key]);
                            continue;
                        }
                        profile.innerHTML += `<br><b>${key}</b>: ${data[key]}`;
                    }
                }
                if (noticesIds.length != 0){
                   noticesIds.forEach((element,index) => {     
                       fetch(`/notices/getById?noticeId=${element}`).then(res => res.json()).then(data =>{
                           if(!data) return;
                           const {isSuspended} = data;
                            noticesDiv.innerHTML += "<hr>";
                           for(key in data){
                               noticesDiv.innerHTML += `<br> ${key}: ${data[key]}`;
                           }
                           if (isSuspended){
                            noticesDiv.innerHTML +=`<button class="susspend" id="${data._id}">Wznów</button>`;
                           } else {
                            noticesDiv.innerHTML +=`<button class="susspend" id="${data._id}">Zawieś</button>`; 
                           }
                           noticesDiv.innerHTML += 
                           `
                            <button class="delete" id="${element}">Usuń</button>
                            <button class="edit" id="${element}">Edytuj</button>

                           `;
                           document.querySelectorAll(".susspend, .delete, .edit").forEach(element=>{
                            element.addEventListener('click',(e)=>{
                                const noticeId = e.target.id;
                                const buttonClass = e.target.className;
                                switch (buttonClass){
                                    case "susspend":
                                        fetch(`/notices/suspendById?noticeId=${noticeId}`, { method: "PUT", }).then(res => res.json())
                                            .then(data => {
                                                if (data.success){
                                                    if(e.target.textContent === "Wznów") e.target.textContent = "Zawieś";
                                                    else e.target.textContent = "Wznów";
                                                    window.location.reload(true);
                                                }
                                            });
                                        break;
                                    case "delete":
                                        fetch(`/notices/delete?noticeId=${noticeId}`, {method: "DELETE"}).then(res => res.json())
                                            .then(data => {
                                                if (data.success){
                                                    if(e.target.textContent === "Wznów") e.target.textContent = "Zawieś";
                                                    else e.target.textContent = "Wznów";
                                                    window.location.reload(true);
                                                }
                                            });
                                        break;
                                    case "edit":
                                        window.location.href = (`/noticeEditor?id=${noticeId}`);
                                        break;
                                }
                            })
                            })
                       });
                   })
                }
            });
        });
    </script>
</body>

</html>